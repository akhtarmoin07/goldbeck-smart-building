name: üõ°Ô∏è Enterprise DevSecOps Pipeline

on:
  push:
    paths:
      - 'src/sensor-ingestor/**'              # Run when App code changes
      - '.github/workflows/devsecops-pipeline.yaml'
  pull_request:
    paths:
      - 'src/sensor-ingestor/**'

permissions:
  id-token: write             # üö® REQUIRED for OIDC Authentication
  contents: write             # REQUIRED to push GitOps updates back to repos
  pull-requests: read

jobs:
  # ==========================================================
  # JOB 1: SECURITY & QUALITY SCANS (Your Existing Logic)
  # ==========================================================
  security-and-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 1. SonarCloud Code Quality Scan
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=akhtarmoin07
            -Dsonar.projectKey=akhtarmoin07_goldbeck-smart-building
            -Dsonar.sources=src/sensor-ingestor
            -Dsonar.host.url=https://sonarcloud.io

      # 2. Snyk Security Scan
      - name: Snyk Open Source Scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --skip-unresolved --file=src/sensor-ingestor/requirements.txt

  # ==========================================================
  # JOB 2: BUILD & PUBLISH TO ACR + GITOPS UPDATE
  # ==========================================================
  build-and-publish:
    needs: security-and-quality
    runs-on: ubuntu-latest
    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ‚ûï 1. AZURE LOGIN (REQUIRED BEFORE GETTING TOKEN)
      - name: 'Azure CLI Login (OIDC)'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 2. üîë FETCH TOKEN: Get a temporary password from Azure
      - name: Get ACR Token
        id: acr_token
        run: |
          TOKEN=$(az acr login --name $ACR_NAME --expose-token --output tsv --query accessToken)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      # 3. üê≥ DOCKER LOGIN: Explicitly log in using that token
      - name: Login to ACR (Docker)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: 00000000-0000-0000-0000-000000000000
          password: ${{ steps.acr_token.outputs.token }}

      # 4. Build and Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: src/sensor-ingestor
          file: src/sensor-ingestor/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/sensor-ingestor:latest
            ${{ env.ACR_NAME }}.azurecr.io/sensor-ingestor:${{ github.sha }}

      # 5. üåâ THE BRIDGE: Update GitOps Manifest
      - name: Update Kubernetes Manifest
        run: |
          sudo snap install yq
          git config user.name "GitHub Actions Bot"
          git config user.email "bot@github.com"
          
          # Update the tag
          yq e '.spec.template.spec.containers[0].image = "${{ env.ACR_NAME }}.azurecr.io/sensor-ingestor:${{ github.sha }}"' -i gitops/apps/sensor-ingestor.yaml
          
          # Commit and Push
          git add gitops/apps/sensor-ingestor.yaml
          git commit -m "Bump sensor-ingestor to version ${{ github.sha }}"
          git push
name: Enterprise DevSecOps Pipeline

on:
  push:
    paths:
      - 'src/sensor-ingestor/**'           # Only run if App code changes
      - '.github/workflows/security-scan.yml' # Or if this pipeline file changes
  pull_request:
    paths:
      - 'src/sensor-ingestor/**'

jobs:
  # JOB 1: SECURITY & QUALITY SCAN
  security-and-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Shallow clones disable SonarCloud analysis

      # 1. SonarCloud Code Quality Scane
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=akhtarmoin07
            -Dsonar.projectKey=akhtarmoin07_goldbeck-smart-building
            -Dsonar.sources=.
            -Dsonar.host.url=https://sonarcloud.io

      # 2. Trivy IaC & Secret Scan (Commented out as per your snippet)
      # - name: Trivy Vulnerability Scanner
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'fs'
      #     scan-ref: '.'
      #     scanners: 'vuln,config,secret'
      #     format: 'table'
      #     exit-code: '1'
      #     severity: 'CRITICAL,HIGH'

      # 3. Snyk Python Scan
      - name: Snyk Open Source Scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --skip-unresolved --file=src/sensor-ingestor/requirements.txt

# JOB 2: BUILD & PUBLISH TO ACR + UPDATE GITOPS
  build-and-publish:
    needs: security-and-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Needed to push changes back to Git

      # 1. Login to Azure Container Registry (Instead of Docker Hub)
      - name: Login to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }} # Add this Secret!
          username: ${{ secrets.ACR_USERNAME }}     # Add this Secret!
          password: ${{ secrets.ACR_PASSWORD }}     # Add this Secret!

      # 2. Build and Push (With Unique Version Tag)
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: src/sensor-ingestor
          file: src/sensor-ingestor/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/sensor-ingestor:latest
            ${{ secrets.ACR_LOGIN_SERVER }}/sensor-ingestor:${{ github.sha }}

      # 3. THE BRIDGE: Update Kubernetes Manifest in Git
      - name: Update Kubernetes Manifest
        run: |
          # Install yq (Tool to edit YAML files safely)
          sudo snap install yq

          # Configure Git
          git config user.name "GitHub Actions Bot"
          git config user.email "bot@github.com"

          # Update the Image Tag in the Manifest
          # (Assumes your file is at gitops/apps/sensor-ingestor.yaml)
          yq e '.spec.template.spec.containers[0].image = "${{ secrets.ACR_LOGIN_SERVER }}/sensor-ingestor:${{ github.sha }}"' -i gitops/apps/sensor-ingestor.yaml

          # Commit and Push the Change
          git add gitops/apps/sensor-ingestor.yaml
          git commit -m "Bump sensor-ingestor to version ${{ github.sha }}"
          git push